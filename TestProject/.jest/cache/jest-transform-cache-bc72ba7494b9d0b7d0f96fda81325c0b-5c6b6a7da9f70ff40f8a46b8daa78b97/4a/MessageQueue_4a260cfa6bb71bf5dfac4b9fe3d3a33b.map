{"version":3,"sources":["MessageQueue.js"],"names":["ErrorUtils","require","Systrace","deepFreezeAndThrowOnMutationInDev","invariant","stringifySafe","TO_JS","TO_NATIVE","MODULE_IDS","METHOD_IDS","PARAMS","MIN_TIME_BETWEEN_FLUSHES_MS","TRACE_TAG_REACT_APPS","DEBUG_INFO_LIMIT","JSTimers","MessageQueue","shouldUninstallGlobalErrorHandler","_lazyCallableModules","_queue","_successCallbacks","_failureCallbacks","_callID","_lastFlush","_eventLoopStartTime","Date","getTime","uninstallGlobalErrorHandler","installGlobalErrorHandler","__DEV__","_debugInfo","_remoteModuleTable","_remoteMethodTable","callFunctionReturnFlushedQueue","bind","callFunctionReturnResultAndFlushedQueue","flushedQueue","invokeCallbackAndReturnFlushedQueue","module","method","args","__guard","__callFunction","result","cbID","__invokeCallback","__callImmediates","queue","length","name","factory","getValue","moduleID","methodID","params","onFail","onSucc","push","global","nativeTraceBeginAsyncFlow","isValidArgument","t","val","Array","isArray","every","k","now","nativeFlushQueueImmediate","_inCall","counterEvent","__spy","isFinite","type","methods","__guardUnsafe","__guardSafe","fn","error","reportFatalError","beginEvent","callImmediates","endEvent","moduleMethods","getCallableModule","apply","callID","isSuccess","callback","debug","errorMessage","profileName","spyOrToggle","prototype","console","log","info","JSON","stringify","exports"],"mappings":"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","file":"MessageQueue.js","sourcesContent":["/**\n * Copyright (c) 2015-present, Facebook, Inc.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n *\n * @providesModule MessageQueue\n * @flow\n * @format\n */\n\n'use strict';\n\nconst ErrorUtils = require('ErrorUtils');\nconst Systrace = require('Systrace');\n\nconst deepFreezeAndThrowOnMutationInDev = require('deepFreezeAndThrowOnMutationInDev');\nconst invariant = require('fbjs/lib/invariant');\nconst stringifySafe = require('stringifySafe');\n\nexport type SpyData = {\n  type: number,\n  module: ?string,\n  method: string | number,\n  args: any[],\n};\n\nconst TO_JS = 0;\nconst TO_NATIVE = 1;\n\nconst MODULE_IDS = 0;\nconst METHOD_IDS = 1;\nconst PARAMS = 2;\nconst MIN_TIME_BETWEEN_FLUSHES_MS = 5;\n\n// eslint-disable-next-line no-bitwise\nconst TRACE_TAG_REACT_APPS = 1 << 17;\n\nconst DEBUG_INFO_LIMIT = 32;\n\n// Work around an initialization order issue\nlet JSTimers = null;\n\nclass MessageQueue {\n  _lazyCallableModules: {[key: string]: (void) => Object};\n  _queue: [number[], number[], any[], number];\n  _successCallbacks: (?Function)[];\n  _failureCallbacks: (?Function)[];\n  _callID: number;\n  _inCall: number;\n  _lastFlush: number;\n  _eventLoopStartTime: number;\n\n  _debugInfo: {[number]: [number, number]};\n  _remoteModuleTable: {[number]: string};\n  _remoteMethodTable: {[number]: string[]};\n\n  __spy: ?(data: SpyData) => void;\n\n  __guard: (() => void) => void;\n\n  constructor(shouldUninstallGlobalErrorHandler: boolean = false) {\n    this._lazyCallableModules = {};\n    this._queue = [[], [], [], 0];\n    this._successCallbacks = [];\n    this._failureCallbacks = [];\n    this._callID = 0;\n    this._lastFlush = 0;\n    this._eventLoopStartTime = new Date().getTime();\n    if (shouldUninstallGlobalErrorHandler) {\n      this.uninstallGlobalErrorHandler();\n    } else {\n      this.installGlobalErrorHandler();\n    }\n\n    if (__DEV__) {\n      this._debugInfo = {};\n      this._remoteModuleTable = {};\n      this._remoteMethodTable = {};\n    }\n\n    (this: any).callFunctionReturnFlushedQueue = this.callFunctionReturnFlushedQueue.bind(\n      this,\n    );\n    (this: any).callFunctionReturnResultAndFlushedQueue = this.callFunctionReturnResultAndFlushedQueue.bind(\n      this,\n    );\n    (this: any).flushedQueue = this.flushedQueue.bind(this);\n    (this: any).invokeCallbackAndReturnFlushedQueue = this.invokeCallbackAndReturnFlushedQueue.bind(\n      this,\n    );\n  }\n\n  /**\n   * Public APIs\n   */\n\n  static spy(spyOrToggle: boolean | ((data: SpyData) => void)) {\n    if (spyOrToggle === true) {\n      MessageQueue.prototype.__spy = info => {\n        console.log(\n          `${info.type === TO_JS ? 'N->JS' : 'JS->N'} : ` +\n            `${info.module ? info.module + '.' : ''}${info.method}` +\n            `(${JSON.stringify(info.args)})`,\n        );\n      };\n    } else if (spyOrToggle === false) {\n      MessageQueue.prototype.__spy = null;\n    } else {\n      MessageQueue.prototype.__spy = spyOrToggle;\n    }\n  }\n\n  callFunctionReturnFlushedQueue(module: string, method: string, args: any[]) {\n    this.__guard(() => {\n      this.__callFunction(module, method, args);\n    });\n\n    return this.flushedQueue();\n  }\n\n  callFunctionReturnResultAndFlushedQueue(\n    module: string,\n    method: string,\n    args: any[],\n  ) {\n    let result;\n    this.__guard(() => {\n      result = this.__callFunction(module, method, args);\n    });\n\n    return [result, this.flushedQueue()];\n  }\n\n  invokeCallbackAndReturnFlushedQueue(cbID: number, args: any[]) {\n    this.__guard(() => {\n      this.__invokeCallback(cbID, args);\n    });\n\n    return this.flushedQueue();\n  }\n\n  flushedQueue() {\n    this.__guard(() => {\n      this.__callImmediates();\n    });\n\n    const queue = this._queue;\n    this._queue = [[], [], [], this._callID];\n    return queue[0].length ? queue : null;\n  }\n\n  getEventLoopRunningTime() {\n    return new Date().getTime() - this._eventLoopStartTime;\n  }\n\n  registerCallableModule(name: string, module: Object) {\n    this._lazyCallableModules[name] = () => module;\n  }\n\n  registerLazyCallableModule(name: string, factory: void => Object) {\n    let module: Object;\n    let getValue: ?(void) => Object = factory;\n    this._lazyCallableModules[name] = () => {\n      if (getValue) {\n        module = getValue();\n        getValue = null;\n      }\n      return module;\n    };\n  }\n\n  getCallableModule(name: string) {\n    const getValue = this._lazyCallableModules[name];\n    return getValue ? getValue() : null;\n  }\n\n  enqueueNativeCall(\n    moduleID: number,\n    methodID: number,\n    params: any[],\n    onFail: ?Function,\n    onSucc: ?Function,\n  ) {\n    if (onFail || onSucc) {\n      if (__DEV__) {\n        this._debugInfo[this._callID] = [moduleID, methodID];\n        if (this._callID > DEBUG_INFO_LIMIT) {\n          delete this._debugInfo[this._callID - DEBUG_INFO_LIMIT];\n        }\n      }\n      // Encode callIDs into pairs of callback identifiers by shifting left and using the rightmost bit\n      // to indicate fail (0) or success (1)\n      // eslint-disable-next-line no-bitwise\n      onFail && params.push(this._callID << 1);\n      // eslint-disable-next-line no-bitwise\n      onSucc && params.push((this._callID << 1) | 1);\n      this._successCallbacks[this._callID] = onSucc;\n      this._failureCallbacks[this._callID] = onFail;\n    }\n\n    if (__DEV__) {\n      global.nativeTraceBeginAsyncFlow &&\n        global.nativeTraceBeginAsyncFlow(\n          TRACE_TAG_REACT_APPS,\n          'native',\n          this._callID,\n        );\n    }\n    this._callID++;\n\n    this._queue[MODULE_IDS].push(moduleID);\n    this._queue[METHOD_IDS].push(methodID);\n\n    if (__DEV__) {\n      // Validate that parameters passed over the bridge are\n      // folly-convertible.  As a special case, if a prop value is a\n      // function it is permitted here, and special-cased in the\n      // conversion.\n      const isValidArgument = val => {\n        const t = typeof val;\n        if (\n          t === 'undefined' ||\n          t === 'null' ||\n          t === 'boolean' ||\n          t === 'number' ||\n          t === 'string'\n        ) {\n          return true;\n        }\n        if (t === 'function' || t !== 'object') {\n          return false;\n        }\n        if (Array.isArray(val)) {\n          return val.every(isValidArgument);\n        }\n        for (const k in val) {\n          if (typeof val[k] !== 'function' && !isValidArgument(val[k])) {\n            return false;\n          }\n        }\n        return true;\n      };\n\n      invariant(\n        isValidArgument(params),\n        '%s is not usable as a native method argument',\n        params,\n      );\n\n      // The params object should not be mutated after being queued\n      deepFreezeAndThrowOnMutationInDev((params: any));\n    }\n    this._queue[PARAMS].push(params);\n\n    const now = new Date().getTime();\n    if (\n      global.nativeFlushQueueImmediate &&\n      (now - this._lastFlush >= MIN_TIME_BETWEEN_FLUSHES_MS ||\n        this._inCall === 0)\n    ) {\n      var queue = this._queue;\n      this._queue = [[], [], [], this._callID];\n      this._lastFlush = now;\n      global.nativeFlushQueueImmediate(queue);\n    }\n    Systrace.counterEvent('pending_js_to_native_queue', this._queue[0].length);\n    if (__DEV__ && this.__spy && isFinite(moduleID)) {\n      this.__spy({\n        type: TO_NATIVE,\n        module: this._remoteModuleTable[moduleID],\n        method: this._remoteMethodTable[moduleID][methodID],\n        args: params,\n      });\n    } else if (this.__spy) {\n      this.__spy({\n        type: TO_NATIVE,\n        module: moduleID + '',\n        method: methodID,\n        args: params,\n      });\n    }\n  }\n\n  createDebugLookup(moduleID: number, name: string, methods: string[]) {\n    if (__DEV__) {\n      this._remoteModuleTable[moduleID] = name;\n      this._remoteMethodTable[moduleID] = methods;\n    }\n  }\n\n  uninstallGlobalErrorHandler() {\n    this.__guard = this.__guardUnsafe;\n  }\n\n  installGlobalErrorHandler() {\n    this.__guard = this.__guardSafe;\n  }\n\n  /**\n   * Private methods\n   */\n\n  // Lets exceptions propagate to be handled by the VM at the origin\n  __guardUnsafe(fn: () => void) {\n    this._inCall++;\n    fn();\n    this._inCall--;\n  }\n\n  __guardSafe(fn: () => void) {\n    this._inCall++;\n    try {\n      fn();\n    } catch (error) {\n      ErrorUtils.reportFatalError(error);\n    } finally {\n      this._inCall--;\n    }\n  }\n\n  __callImmediates() {\n    Systrace.beginEvent('JSTimers.callImmediates()');\n    if (!JSTimers) {\n      JSTimers = require('JSTimers');\n    }\n    JSTimers.callImmediates();\n    Systrace.endEvent();\n  }\n\n  __callFunction(module: string, method: string, args: any[]): any {\n    this._lastFlush = new Date().getTime();\n    this._eventLoopStartTime = this._lastFlush;\n    Systrace.beginEvent(`${module}.${method}()`);\n    if (this.__spy) {\n      this.__spy({type: TO_JS, module, method, args});\n    }\n    const moduleMethods = this.getCallableModule(module);\n    invariant(\n      !!moduleMethods,\n      'Module %s is not a registered callable module (calling %s)',\n      module,\n      method,\n    );\n    invariant(\n      !!moduleMethods[method],\n      'Method %s does not exist on module %s',\n      method,\n      module,\n    );\n    const result = moduleMethods[method].apply(moduleMethods, args);\n    Systrace.endEvent();\n    return result;\n  }\n\n  __invokeCallback(cbID: number, args: any[]) {\n    this._lastFlush = new Date().getTime();\n    this._eventLoopStartTime = this._lastFlush;\n\n    // The rightmost bit of cbID indicates fail (0) or success (1), the other bits are the callID shifted left.\n    // eslint-disable-next-line no-bitwise\n    const callID = cbID >>> 1;\n    // eslint-disable-next-line no-bitwise\n    const isSuccess = cbID & 1;\n    const callback = isSuccess\n      ? this._successCallbacks[callID]\n      : this._failureCallbacks[callID];\n\n    if (__DEV__) {\n      const debug = this._debugInfo[callID];\n      const module = debug && this._remoteModuleTable[debug[0]];\n      const method = debug && this._remoteMethodTable[debug[0]][debug[1]];\n      if (!callback) {\n        let errorMessage = `Callback with id ${cbID}: ${module}.${method}() not found`;\n        if (method) {\n          errorMessage =\n            `The callback ${method}() exists in module ${module}, ` +\n            'but only one callback may be registered to a function in a native module.';\n        }\n        invariant(callback, errorMessage);\n      }\n      const profileName = debug\n        ? '<callback for ' + module + '.' + method + '>'\n        : cbID;\n      if (callback && this.__spy) {\n        this.__spy({type: TO_JS, module: null, method: profileName, args});\n      }\n      Systrace.beginEvent(\n        `MessageQueue.invokeCallback(${profileName}, ${stringifySafe(args)})`,\n      );\n    }\n\n    if (!callback) {\n      return;\n    }\n\n    this._successCallbacks[callID] = this._failureCallbacks[callID] = null;\n    callback(...args);\n\n    if (__DEV__) {\n      Systrace.endEvent();\n    }\n  }\n}\n\nmodule.exports = MessageQueue;\n"]}